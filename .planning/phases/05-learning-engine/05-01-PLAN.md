# 05-01: Post-call Analysis Pipeline

**Goal**: Implement asynchronous transcript analysis using Redis Streams and OpenAI (gpt-4o-mini).

**Depends on**: Phase 3 (Voice Pipeline - for transcripts), Phase 1 (Redis)

## Requirements
- **Async Processing**: Bot must not block on analysis. Use Redis Streams (`call:analysis`).
- **Structured Extraction**: Extract `outcome`, `summary`, `sentiment`, and `missing_info`.
- **Cost Efficiency**: Use `gpt-4o-mini`.

## Implementation Details

### 1. Requirements & Config
- Add `weave` and `wandb` to `requirements.txt`.
- Add `wandb_api_key` to `config.py`.

### 2. Analysis Logic (`app/learning/analysis.py`)
- Define `CallAnalysis` Pydantic model.
- Implement `CallAnalyzer` class:
    - `analyze_transcript(transcript: str) -> CallAnalysis`: Sends transcript to OpenAI with system prompt instructing it to extract key metrics and missing info.
    - Decorate with `@weave.op` to track analysis inputs/outputs immediately.

### 3. Worker Process (`app/worker.py`)
- Implement a standalone script that:
    - Connects to Redis.
    - Creates consumer group for `call:analysis`.
    - Loops: `xreadgroup` -> `analyze_transcript` -> `store_results`.
    - Stores results in Redis HashMap `analysis:{call_id}`.

### 4. Bot Integration (`app/voice/bot.py`)
- Modify `on_participant_left`:
    - Instead of just logging, `xadd("call:analysis", {"call_id": call_id})`.

## Verification
- **Unit Tests**: `tests/learning/test_analysis.py`.
- **Integration Test**: 
    1. Start worker.
    2. Push dummy call ID to stream.
    3. Verify `analysis:{id}` key exists with expected data.
