# 04-03: Knowledge Base + Emergency/Clinical Routing

**Status:** Planned
**Depends on:** 04-01 (verification gate, prompts.py), Phase 3 (pipeline)
**Requirements:** HIPA-04, HIPA-05, CALL-03, CALL-04, CALL-05

## Goal

1. **Knowledge base** — Answer office FAQs (hours, directions, insurance) via Redis vector search. No verification required.
2. **Emergency detection** — Pre-LLM keyword scanner that immediately triggers emergency flow. Prompt backup for edge cases.
3. **Clinical routing** — Detect clinical/medical-advice questions and transfer to staff.

---

## Part A: Emergency Detection (Pre-LLM)

### [NEW] `backend/app/voice/emergency.py`

`EmergencyDetector(FrameProcessor)` — sits in pipeline between STT and UserAggregator.

**Design:**
- Scans every `TranscriptionFrame.text` for emergency keywords via set membership / regex
- Keywords: `chest pain`, `can't breathe`, `heart attack`, `stroke`, `bleeding`, `unconscious`, `suicide`, `overdose`, `911`, `difficulty breathing`, `allergic reaction`, `passing out`, `killing myself`, `want to die`, `self-harm`
- Sub-millisecond: lowercase + `any(kw in text for kw in KEYWORDS)` — no ML, no API calls
- On trigger: inject `LLMMessagesFrame` with emergency system override message, transition call state → TRANSFERRING

**Pipeline placement:**
```
transport.input() → stt → emergency_detector → transcript_logger → context.user() → llm → ...
```

### [MODIFY] `backend/app/voice/prompts.py`

Add `EMERGENCY_OVERRIDE_MESSAGE`:
```
"EMERGENCY DETECTED. The caller may be experiencing a medical emergency.
Immediately tell them: 'This sounds like it could be a medical emergency.
Please hang up and call 911 immediately, or go to your nearest emergency room.
If you need me to stay on the line while you call, I can do that.'
Do NOT attempt to schedule or verify identity."
```

Add backup instructions to both system prompts:
```
"If the patient mentions any medical emergency (chest pain, difficulty breathing,
stroke symptoms, suicidal thoughts), immediately provide emergency guidance
regardless of verification status."
```

---

## Part B: Knowledge Base (Redis Vector Search)

### [NEW] `backend/app/voice/knowledge.py`

`KnowledgeBase` class:
- `seed(practice_data: dict)` — embeds FAQ entries via OpenAI `text-embedding-3-small`, stores in Redis
- `query(question: str, top_k: int = 3) -> List[dict]` — embeds query, runs vector similarity search
- Redis index: `idx:knowledge` with HNSW algorithm, cosine similarity, 1536 dimensions

**Seeded FAQ data** (Valley Family Medicine):
- Office hours: Mon-Fri 8am-5pm, closed weekends
- Address: 123 Valley Blvd, Suite 200
- Phone: (555) 867-5309
- Insurance accepted: Aetna, Blue Cross, United, Cigna, Medicare
- New patient process: bring ID, insurance card, arrive 15min early
- Cancellation policy: 24-hour notice required

### [NEW] `backend/app/voice/tools.py` (addition)

| Tool | Gated? | Purpose |
|------|--------|---------|
| `search_knowledge_base` | ❌ No | Query office FAQs — no verification needed |

### [MODIFY] `backend/app/voice/prompts.py`

Add to both pre/post verification prompts:
```
"For general office questions (hours, location, insurance, policies),
use the search_knowledge_base tool. These do NOT require identity verification."
```

---

## Part C: Clinical Routing

### [MODIFY] `backend/app/voice/prompts.py`

Add clinical routing instructions to post-verification prompt:
```
"If the patient asks for medical advice, diagnosis, or treatment recommendations,
tell them: 'I'm not able to provide medical advice. Let me transfer you to a nurse
who can help.' Then transition the call to transfer."
```

No separate classifier needed — the LLM's instruction-following is reliable for this, and the PITFALLS doc rates clinical routing as lower risk than emergency detection. The prompt handles it.

---

## Files Summary

| File | Change | Part |
|------|--------|------|
| `backend/app/voice/emergency.py` | NEW | A |
| `backend/app/voice/knowledge.py` | NEW | B |
| `backend/app/voice/tools.py` | MODIFY | B (add `search_knowledge_base`) |
| `backend/app/voice/prompts.py` | MODIFY | A, B, C |
| `backend/app/voice/bot.py` | MODIFY | A (insert EmergencyDetector in pipeline) |
| `backend/app/main.py` | MODIFY | B (seed knowledge base on startup) |

## Tests

### [NEW] `backend/tests/test_emergency.py`

- Exact keyword match → triggers emergency
- Partial phrase match → triggers (e.g., "my chest really hurts" contains "chest")
- Non-emergency text → passes through
- Case insensitive match
- Performance: <1ms per frame (assert via timing)

### [NEW] `backend/tests/test_knowledge.py`

- Seed + query returns relevant results
- Query with no match returns empty
- Mocked OpenAI embeddings (deterministic test vectors)

## Verification

```bash
python -m pytest tests/test_emergency.py tests/test_knowledge.py -v
```
