# 04-02: Scheduling Flow with EHR Function Calls

**Status:** Planned
**Depends on:** 04-01 (verification gate, tools.py, prompts.py)
**Requirements:** CALL-02, CALL-06, EHR-04

## Goal

Patient can search for available appointments, select a slot, and book — all through natural conversation. The LLM uses function calling to interact with the EHR. Full details are read back before confirmation.

## Flow

```
Patient (verified) asks about appointment
    → LLM calls get_availability(provider_id, start, end)
    → LLM presents options naturally ("Dr. Patel has openings Tuesday at 10am and 2pm...")
    → Patient selects slot
    → LLM calls book_appointment(patient_id, slot_id, visit_type)
    → LLM reads back: "I've booked you with Dr. Patel on Tuesday Jan 14 at 10:00 AM for a follow-up. Is that correct?"
    → Patient confirms → call state → COMPLETED
```

## Files

### [MODIFY] `backend/app/voice/tools.py`

Enhance tool schemas with richer parameter descriptions so the LLM can populate them from conversation context:

- `get_availability` — add `description` fields for each param explaining what natural language maps to (e.g., "next Tuesday" → computed date)
- `book_appointment` — add `visit_type` enum values in schema so LLM can map patient language ("check-up" → `CHECKUP`, "follow-up" → `FOLLOWUP`)

Add a new helper tool:

| Tool | Gated? | Purpose |
|------|--------|---------|
| `list_providers` | ✅ Yes | Returns available practitioners so LLM can offer "Which doctor would you like to see?" |

### [MODIFY] `backend/app/voice/prompts.py`

Expand `POST_VERIFICATION_PROMPT` with scheduling instructions:
- "When the patient wants to schedule, first ask which provider they'd like to see"
- "Always suggest 2-3 time options, don't overwhelm with a long list"
- "Before booking, ALWAYS read back the full details and ask for confirmation"
- "Map patient language to visit types: 'check-up'/'annual' → CHECKUP, 'follow-up' → FOLLOWUP, 'sick visit'/'urgent' → URGENT"

### [MODIFY] `backend/app/services/ehr/interface.py`

Add `list_practitioners() -> List[Practitioner]` to interface.

### [MODIFY] `backend/app/services/ehr/mock.py`

Implement `list_practitioners()` — returns all seeded practitioners.

### [NEW] `backend/tests/test_scheduling_flow.py`

- Test `list_providers` returns practitioners (gated)
- Test `get_availability` returns slots for valid provider
- Test `get_availability` returns empty for non-existent provider
- Test `book_appointment` succeeds for free slot
- Test `book_appointment` fails for busy/nonexistent slot
- Test full sequence: list → availability → book → verify booked

## Verification

```bash
python -m pytest tests/test_scheduling_flow.py tests/test_tools.py -v
```
