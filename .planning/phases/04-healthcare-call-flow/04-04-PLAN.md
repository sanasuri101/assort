# 04-04: SMS Confirmation, Call Outcome Tracking, End-to-End Tests

**Status:** Planned
**Depends on:** 04-01, 04-02, 04-03
**Requirements:** SMS-01, TRNS-02, TRNS-03, CALL-02

## Goal

1. **SMS confirmation** — After successful booking, send SMS to patient via Twilio.
2. **Call outcome tracking** — Classify and store call outcomes (scheduled, answered, transferred, abandoned).
3. **End-to-end tests** — Validate the full flow from greeting through booking/transfer/emergency.

---

## Part A: SMS Confirmation (Twilio)

### [NEW] `backend/app/services/sms.py`

`SMSService` class:
- `send_confirmation(phone: str, appointment: Appointment, provider_name: str)`
- Uses Twilio REST API (`settings.twilio_account_sid`, `settings.twilio_auth_token`, `settings.twilio_phone_number`)
- Message template: "Your appointment with Dr. {name} on {date} at {time} has been confirmed. Reply CANCEL to cancel. - Valley Family Medicine"
- Mock mode: if no Twilio credentials, log the SMS instead of sending

### [MODIFY] `backend/app/voice/tools.py`

After `book_appointment` succeeds:
- Retrieve patient phone from EHR data
- Call `SMSService.send_confirmation()`
- Include confirmation in tool response: `{"appointment_id": "...", "sms_sent": true}`

---

## Part B: Call Outcome Tracking

### [MODIFY] `backend/app/voice/call_state.py`

Add call outcome classification:

```python
class CallOutcome(str, Enum):
    SCHEDULED = "scheduled"     # Appointment booked
    ANSWERED = "answered"       # FAQ/knowledge base question answered
    TRANSFERRED = "transferred" # Handed off to staff
    ABANDONED = "abandoned"     # Caller hung up
    EMERGENCY = "emergency"     # Emergency detected
```

- `set_outcome(call_id, outcome)` — stores outcome in call hash
- `get_call_summary(call_id) -> dict` — returns full call metadata: state, outcome, duration, patient_id, provider_id

### [MODIFY] `backend/app/voice/bot.py`

- On pipeline end/disconnect: classify outcome based on final state and actions taken
- Calculate duration (start_time to end_time)
- Store via `call_state.set_outcome()` + `call_state.set_metadata()`

### [NEW] `backend/app/routers/calls.py`

REST endpoints for call data (consumed by future dashboard):
- `GET /api/calls/{call_id}` — get call summary
- `GET /api/calls?limit=20&outcome=scheduled` — list recent calls with optional filtering

### [MODIFY] `backend/app/main.py`

Register calls router.

---

## Part C: End-to-End Tests

### [NEW] `backend/tests/test_e2e_flows.py`

Test the full tool chain (not the voice pipeline, but the tool execution layer):

1. **Scheduling E2E**: create call → verify patient → list providers → get availability → book → SMS → outcome = SCHEDULED
2. **Knowledge Base E2E**: create call → search_knowledge_base("hours") → outcome = ANSWERED
3. **Emergency E2E**: create call → emergency keyword detected → outcome = EMERGENCY
4. **Verification Failure**: create call → verify with wrong DOB → tools still gated → no PHI leaked
5. **Transfer E2E**: create call → verify → clinical question → outcome = TRANSFERRED

Each test uses the real `MockEHRAdapter` and mocked Redis, exercising `tools.py` handlers directly.

---

## Files Summary

| File | Change |
|------|--------|
| `backend/app/services/sms.py` | NEW |
| `backend/app/voice/tools.py` | MODIFY (SMS after booking) |
| `backend/app/voice/call_state.py` | MODIFY (CallOutcome, set_outcome, get_call_summary) |
| `backend/app/voice/bot.py` | MODIFY (outcome classification on disconnect) |
| `backend/app/routers/calls.py` | NEW |
| `backend/app/main.py` | MODIFY (register calls router) |
| `backend/tests/test_e2e_flows.py` | NEW |

## Verification

```bash
python -m pytest tests/ -v
# All tests pass including new E2E suite
```
