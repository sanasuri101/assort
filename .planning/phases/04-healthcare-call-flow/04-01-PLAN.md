# 04-01: Identity Verification Gate

**Status:** Planned
**Depends on:** Phase 3 (bot.py, call_state.py), Phase 2 (EHR interface)
**Requirements:** HIPA-03, CALL-01

## Goal

No EHR function calls execute before caller identity is confirmed (name + DOB match). `lookup_patient` is the sole pre-verification exception because it IS the verification mechanism.

## Design Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Gate enforcement | Execution-level | All tools always registered; gated functions check `call_state == VERIFIED`. Avoids fragile mid-conversation tool schema changes |
| `lookup_patient` | Pre-verification exception | Takes name + DOB, matches EHR, transitions state to VERIFIED on match |
| System prompts | Dual (belt + suspenders) | Pre-verification prompt restricts to collecting name/DOB; post-verification unlocks full capabilities |

## Files

### [NEW] `backend/app/voice/tools.py`

OpenAI function-calling tool definitions + execution handlers:

| Tool | Gated? | Calls |
|------|--------|-------|
| `verify_patient` | ❌ No | `EHRService.lookup_patient()` → transitions to VERIFIED on match |
| `get_availability` | ✅ Yes | `EHRService.get_availability()` |
| `book_appointment` | ✅ Yes | `EHRService.book_appointment()` |
| `check_insurance` | ✅ Yes | `EHRService.check_insurance()` |

Gate pattern for gated tools:
```python
async def execute(self, call_id, call_state, ehr_service, **params):
    if await call_state.get_state(call_id) != CallState.VERIFIED:
        return {"error": "identity_not_verified", "message": "..."}
    return await ehr_service.method(**params)
```

### [NEW] `backend/app/voice/prompts.py`

- `PRE_VERIFICATION_PROMPT` — Greet caller, collect name + DOB only, no PHI
- `POST_VERIFICATION_PROMPT` — Full scheduling capability with patient context

### [MODIFY] `backend/app/voice/bot.py`

- Use `PRE_VERIFICATION_PROMPT` instead of hardcoded prompt
- Initialize `CallStateMachine`, create call on start
- Register all 4 tool schemas with `OpenAILLMContext`
- Add function-call handler: route to `tools.py` → check gate → execute → return
- On `verify_patient` success: swap to `POST_VERIFICATION_PROMPT`

### [MODIFY] `backend/app/voice/call_state.py`

- Add `is_verified(call_id) -> bool` helper
- Store `patient_id` in call metadata on verification

### [NEW] `backend/tests/test_tools.py`

- `verify_patient` match → patient returned, state → VERIFIED
- `verify_patient` no match → not found, state stays ROUTING
- Gated tools before verification → structured error
- Gated tools after verification → success

## Verification

```bash
python -m pytest tests/test_tools.py tests/test_call_state.py -v
```
