---
phase: 01-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/main.py
  - backend/app/config.py
  - backend/app/dependencies.py
  - backend/app/middleware/__init__.py
  - backend/app/middleware/hipaa_audit.py
  - backend/app/middleware/auth.py
autonomous: true

must_haves:
  truths:
    - "Every API request to PHI endpoints is logged with timestamp, caller, resource, and action"
    - "Unauthenticated requests to protected endpoints return 401"
    - "Application settings load from environment variables with validation"
    - "Redis connection is established on startup and closed on shutdown"
  artifacts:
    - path: "backend/app/config.py"
      provides: "Application settings via pydantic-settings"
      contains: "BaseSettings"
    - path: "backend/app/middleware/hipaa_audit.py"
      provides: "HIPAA audit logging middleware"
      contains: "phi_access"
      min_lines: 30
    - path: "backend/app/middleware/auth.py"
      provides: "API key authentication"
      contains: "APIKeyHeader"
    - path: "backend/app/dependencies.py"
      provides: "Redis connection dependency"
      contains: "redis"
    - path: "backend/app/main.py"
      provides: "FastAPI app with middleware and lifespan"
      contains: "HIPAAAuditMiddleware"
  key_links:
    - from: "backend/app/main.py"
      to: "backend/app/middleware/hipaa_audit.py"
      via: "middleware registration"
      pattern: "add_middleware.*HIPAAAudit"
    - from: "backend/app/main.py"
      to: "backend/app/config.py"
      via: "settings import"
      pattern: "from app.config import"
    - from: "backend/app/main.py"
      to: "backend/app/dependencies.py"
      via: "lifespan Redis connection"
      pattern: "lifespan"
    - from: "backend/app/middleware/auth.py"
      to: "backend/app/config.py"
      via: "API key validation"
      pattern: "settings.api_key"
---

<objective>
Implement FastAPI skeleton with HIPAA audit middleware, API key authentication, pydantic-settings configuration, and Redis connection lifecycle.

Purpose: Security and configuration foundation that all future endpoints depend on.
Output: config.py, HIPAA middleware, auth middleware, Redis connection management, updated main.py
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create config, dependencies, and middleware modules</name>
  <files>backend/app/config.py, backend/app/dependencies.py, backend/app/middleware/__init__.py, backend/app/middleware/hipaa_audit.py, backend/app/middleware/auth.py</files>
  <action>
    Create `backend/app/config.py` using pydantic-settings BaseSettings:
    ```python
    from pydantic_settings import BaseSettings

    class Settings(BaseSettings):
        # Redis
        redis_url: str = "redis://localhost:6379/0"

        # API
        api_key: str = "dev-key-change-me"
        api_host: str = "0.0.0.0"
        api_port: int = 8000

        # External Services (used in later phases)
        daily_api_key: str = ""
        deepgram_api_key: str = ""
        openai_api_key: str = ""
        cartesia_api_key: str = ""
        twilio_account_sid: str = ""
        twilio_auth_token: str = ""
        twilio_phone_number: str = ""

        # Logging
        log_level: str = "INFO"
        hipaa_audit_log: bool = True

        model_config = {"env_file": ".env", "env_file_encoding": "utf-8"}

    settings = Settings()
    ```

    Create `backend/app/dependencies.py`:
    - `get_redis()` async dependency that yields Redis client from `app.state.redis`
    - Type hint with `redis.asyncio.Redis`

    Create `backend/app/middleware/__init__.py` (empty).

    Create `backend/app/middleware/hipaa_audit.py`:
    - Subclass `BaseHTTPMiddleware`
    - Define `PHI_PATHS` list: `/api/patients`, `/api/appointments`, `/api/ehr`, `/api/calls`
    - In `dispatch`: log JSON to `hipaa.audit` logger with fields: event="phi_access", timestamp, method, path, caller_ip, api_key (from header or "anonymous"), status_code, duration_ms
    - Use structured JSON logging format
    - Only log for paths matching PHI_PATHS (prefix match)

    Create `backend/app/middleware/auth.py`:
    - Use `fastapi.security.APIKeyHeader` with header name `X-API-Key`
    - Create `verify_api_key` dependency that validates against `settings.api_key`
    - Raise 401 HTTPException with `"Invalid or missing API key"` on failure
    - Export both `api_key_header` and `verify_api_key` for use in routers
  </action>
  <verify>
    Run `python -c "from app.config import settings; print(settings.redis_url)"` from backend directory.
    Run `python -c "from app.middleware.hipaa_audit import HIPAAAuditMiddleware; print('OK')"` from backend directory.
    Run `python -c "from app.middleware.auth import verify_api_key; print('OK')"` from backend directory.
  </verify>
  <done>
    Settings load from environment with defaults. HIPAA audit middleware logs PHI access. API key auth rejects invalid keys. Redis dependency provides async client.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire middleware and lifecycle into FastAPI app</name>
  <files>backend/app/main.py</files>
  <action>
    Update `backend/app/main.py` to:

    1. Import settings, middleware, and Redis:
       ```python
       from contextlib import asynccontextmanager
       from redis.asyncio import Redis
       from app.config import settings
       from app.middleware.hipaa_audit import HIPAAAuditMiddleware
       import logging
       ```

    2. Configure logging at module level:
       ```python
       logging.basicConfig(level=getattr(logging, settings.log_level))
       logger = logging.getLogger("assort_health")
       ```

    3. Create lifespan context manager:
       - On startup: create Redis connection from `settings.redis_url`, ping to verify, store on `app.state.redis`, log "Redis connected"
       - On shutdown: close Redis connection, log "Redis disconnected"

    4. Create FastAPI app with lifespan, title="Assort Health API", version="0.1.0", description="AI Patient Experience Platform"

    5. Add CORS middleware (allow all origins for dev — will restrict in production)

    6. Add HIPAA audit middleware: `app.add_middleware(HIPAAAuditMiddleware)`
       Note: Add HIPAA middleware AFTER CORS — middleware runs LIFO, so HIPAA runs first on requests

    7. Keep existing `/health` endpoint, update to also check Redis:
       ```python
       @app.get("/health")
       async def health():
           try:
               await app.state.redis.ping()
               redis_status = "connected"
           except Exception:
               redis_status = "disconnected"
           return {"status": "ok", "redis": redis_status, "version": "0.1.0"}
       ```
  </action>
  <verify>
    Run `python -c "from app.main import app; print(app.title)"` from backend directory — should print "Assort Health API".
    Verify middleware is registered: `python -c "from app.main import app; print([m.cls.__name__ for m in app.user_middleware])"` — should include HIPAAAuditMiddleware.
  </verify>
  <done>
    FastAPI app has Redis lifecycle (connect on start, close on shutdown), HIPAA audit middleware on all PHI paths, CORS for dev, and health check endpoint showing Redis status.
  </done>
</task>

</tasks>

<verification>
- Config loads from environment with sensible defaults
- HIPAA middleware logs PHI access events as structured JSON
- Auth middleware rejects requests without valid API key
- Redis connection managed via FastAPI lifespan
- Health endpoint returns Redis connection status
</verification>

<success_criteria>
FastAPI app starts with HIPAA audit logging, API key authentication, and Redis connection management. All security and configuration patterns established for future phases.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
