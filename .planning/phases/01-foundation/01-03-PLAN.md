---
phase: 01-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01", "02"]
files_modified:
  - backend/app/routers/__init__.py
  - backend/app/routers/health.py
  - backend/app/main.py
  - backend/tests/__init__.py
  - backend/tests/test_health.py
  - backend/tests/test_middleware.py
autonomous: true

must_haves:
  truths:
    - "Health check endpoint returns status of all services (API, Redis)"
    - "HIPAA audit middleware logs PHI path access in structured JSON"
    - "Unauthenticated requests to protected endpoints return 401"
    - "All tests pass (health checks, middleware, auth)"
  artifacts:
    - path: "backend/app/routers/health.py"
      provides: "Health check router with detailed service status"
      contains: "redis"
    - path: "backend/tests/test_health.py"
      provides: "Health endpoint tests"
      contains: "test_health"
    - path: "backend/tests/test_middleware.py"
      provides: "HIPAA audit and auth middleware tests"
      contains: "test_hipaa"
  key_links:
    - from: "backend/app/main.py"
      to: "backend/app/routers/health.py"
      via: "router include"
      pattern: "include_router"
    - from: "backend/tests/test_health.py"
      to: "backend/app/main.py"
      via: "TestClient import"
      pattern: "from app.main import app"
    - from: "backend/tests/test_middleware.py"
      to: "backend/app/middleware/hipaa_audit.py"
      via: "Middleware testing"
      pattern: "hipaa"
---

<objective>
Add proper health check router, write tests for health/middleware/auth, and validate the full integration.

Purpose: Verify the foundation works end-to-end with automated tests before building on it.
Output: Health check router, test suite, validated middleware behavior
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create health check router and integrate into main app</name>
  <files>backend/app/routers/__init__.py, backend/app/routers/health.py, backend/app/main.py</files>
  <action>
    Create `backend/app/routers/__init__.py` (empty).

    Create `backend/app/routers/health.py`:
    - Define `router = APIRouter(tags=["health"])`
    - `GET /health` — basic health check returning `{"status": "ok", "version": "0.1.0"}`
    - `GET /health/detailed` — detailed health check that pings Redis and reports:
      ```json
      {
        "status": "ok",
        "version": "0.1.0",
        "services": {
          "redis": {"status": "connected", "latency_ms": 1.2},
          "api": {"status": "running"}
        }
      }
      ```
    - Use `request.app.state.redis` to access Redis client
    - If Redis ping fails, set redis status to "disconnected" and overall status to "degraded"
    - Measure Redis ping latency using `time.time()` before/after

    Update `backend/app/main.py`:
    - Move inline `/health` endpoint to use the new router
    - Add `app.include_router(health_router, prefix="")` (no prefix — health endpoints at root)
    - Add a protected test endpoint for auth verification: `GET /api/protected` that requires `verify_api_key` dependency and returns `{"message": "authenticated"}`
  </action>
  <verify>
    Run `python -c "from app.main import app; routes = [r.path for r in app.routes]; print('/health' in routes, '/health/detailed' in routes)"` from backend directory — both should be True.
  </verify>
  <done>
    Health check router provides basic and detailed endpoints. Protected endpoint verifies auth middleware works. All routes registered in main app.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write tests for health, HIPAA audit, and auth middleware</name>
  <files>backend/tests/__init__.py, backend/tests/test_health.py, backend/tests/test_middleware.py, backend/tests/conftest.py</files>
  <action>
    Create `backend/tests/__init__.py` (empty).

    Create `backend/tests/conftest.py`:
    - Create a pytest fixture that provides a `httpx.AsyncClient` with the FastAPI app
    - Mock Redis for tests using `unittest.mock.AsyncMock`:
      ```python
      @pytest.fixture
      async def client():
          from app.main import app
          mock_redis = AsyncMock()
          mock_redis.ping = AsyncMock(return_value=True)
          app.state.redis = mock_redis
          async with httpx.AsyncClient(app=app, base_url="http://test") as ac:
              yield ac
      ```
    - Create a fixture for the valid API key from settings

    Create `backend/tests/test_health.py`:
    - `test_health_endpoint` — GET /health returns 200 with status "ok"
    - `test_health_detailed_redis_connected` — GET /health/detailed returns redis connected status
    - `test_health_detailed_redis_disconnected` — Mock Redis ping to raise, verify status is "degraded"

    Create `backend/tests/test_middleware.py`:
    - `test_hipaa_audit_logs_phi_access` — Make request to PHI path (e.g., /api/patients), verify HIPAA audit logger was called with structured JSON containing event="phi_access", method, path, timestamp
    - `test_hipaa_audit_skips_non_phi_paths` — Make request to /health, verify HIPAA audit logger was NOT called
    - `test_auth_rejects_no_key` — GET /api/protected without X-API-Key header returns 401
    - `test_auth_rejects_invalid_key` — GET /api/protected with wrong X-API-Key returns 401
    - `test_auth_accepts_valid_key` — GET /api/protected with correct X-API-Key returns 200

    Use `pytest-asyncio` for async tests. Mock the HIPAA audit logger to capture log calls.
  </action>
  <verify>
    Run `cd backend && python -m pytest tests/ -v` — all tests should pass.
    Verify test count: should be at least 7 tests.
  </verify>
  <done>
    Test suite validates: health endpoints return correct status, HIPAA middleware logs PHI access (and skips non-PHI), auth middleware rejects invalid/missing keys and accepts valid keys. All tests pass.
  </done>
</task>

</tasks>

<verification>
- `python -m pytest tests/ -v` — all tests pass
- Health check router reports Redis status
- HIPAA middleware logs PHI access events
- Auth middleware blocks unauthenticated requests
- No import errors or missing dependencies
</verification>

<success_criteria>
Foundation is validated with automated tests. Health checks, HIPAA audit logging, and API key authentication all work correctly. Ready to build EHR service and voice pipeline on top.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
